# üìä –ê—É–¥–∏—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞

**–î–∞—Ç–∞**: 19 –¥–µ–∫–∞–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å**: –ê–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

---

## 1. –õ–û–ì–ò–†–û–í–ê–ù–ò–ï üìã

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### –§–∞–π–ª: `app/core/logging_config.py`

```python
# ‚úÖ –ß–¢–û –ï–°–¢–¨:
- coloredlogs –¥–ª—è —Ü–≤–µ—Ç–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª—å
- RotatingFileHandler —Å –ª–∏–º–∏—Ç–æ–º —Ä–∞–∑–º–µ—Ä–∞ (10MB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –ª–æ–≥–æ–≤ (–¥–æ 5 —Ñ–∞–π–ª–æ–≤)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ (httpx, faster_whisper, asyncio)
- UTF-8 –∫–æ–¥–∏—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å timestamp, —É—Ä–æ–≤–Ω–µ–º –∏ –º–æ–¥—É–ª–µ–º
```

### –û—Ü–µ–Ω–∫–∞: ‚≠ê‚≠ê‚≠ê‚≠ê (4/5)

#### ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ä–æ—à–æ –¥–ª—è —Ç–µ–∫—É—â–∏—Ö –Ω—É–∂–¥

| –§—É–Ω–∫—Ü–∏—è | –ï—Å—Ç—å | –£—Ä–æ–≤–µ–Ω—å |
|---------|------|---------|
| –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ | ‚úÖ | –•–æ—Ä–æ—à–∏–π (—Å —Ü–≤–µ—Ç–∞–º–∏) |
| –§–∞–π–ª–æ–≤—ã–π –ª–æ–≥ | ‚úÖ | –•–æ—Ä–æ—à–∏–π (—Ä–æ—Ç–∞—Ü–∏—è) |
| –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è | ‚úÖ | –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä |
| –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ | –•–æ—Ä–æ—à–µ–µ |
| JSON –≤—ã–≤–æ–¥ | ‚ùå | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |
| –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ (—Ç—Ä–µ–π—Å—ã) | ‚ùå | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |
| –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ | ‚ùå | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |

#### ‚ùå –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø—Ä–æ–±–ª–µ–º—ã

1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**
   - –õ–æ–≥–∏ –∫–∞–∫ —Ç–µ–∫—Å—Ç, –Ω–µ –∫–∞–∫ JSON
   - –°–ª–æ–∂–Ω–æ –ø–∞—Ä—Å–∏—Ç—å –ø—Ä–∏ —Å–∫–µ–π–ª–∏–Ω–≥–µ
   - ELK/Splunk –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∑–∞—Ç—Ä—É–¥–Ω–µ–Ω–∞

2. **–ù–µ—Ç tracing/span –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è**
   - –°–ª–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å Request ID —á–µ—Ä–µ–∑ –≤–µ—Å—å —Ü–∏–∫–ª
   - –ù–µ—Ç –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –º–µ–∂–¥—É –ª–æ–≥–∞–º–∏ —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

3. **–ù–µ—Ç metrics/—Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è
   - –í—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è

4. **–†–æ—Ç–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø–æ —Ä–∞–∑–º–µ—Ä—É**
   - –ù–µ —Ä–æ—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ –¥–∞—Ç–µ (–≤—Å–µ –ª–æ–≥–∏ –∑–∞ –Ω–µ–¥–µ–ª—é –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ)

---

## 2. –ö–≠–®–ò–†–û–í–ê–ù–ò–ï üíæ

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### –§–∞–π–ª: `app/services/cache.py`

```python
# ‚úÖ –ß–¢–û –ï–°–¢–¨:
- –§–∞–π–ª–æ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (pickle)
- SHA256 –∫–ª—é—á–∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤
- TTL (time-to-live) —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π mtime
- –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π (clear_old)
- –†–∞–±–æ—Ç–∞ –ø–æ –∫–ª—é—á—É (get_by_key, set_by_key)
- Async-safe —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (asyncio.to_thread)
- –î–µ–∫–æ—Ä–∞—Ç–æ—Ä @cache_analysis –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞

# ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢:
- In-memory –∫—ç—à (Redis)
- –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏–π/–ø—Ä–æ–º–∞—Ö–æ–≤
- –í—ã—Ç–µ—Å–Ω–µ–Ω–∏–µ –ø–æ LRU/LFU
- –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π TTL
```

### –û—Ü–µ–Ω–∫–∞: ‚≠ê‚≠ê‚≠ê (3/5)

#### ‚ö†Ô∏è –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è MVP, –Ω–æ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏

| –§—É–Ω–∫—Ü–∏—è | –ï—Å—Ç—å | –£—Ä–æ–≤–µ–Ω—å |
|---------|------|---------|
| –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å | ‚úÖ | –•–æ—Ä–æ—à–∞—è (–¥–∏—Å–∫) |
| TTL | ‚úÖ | –ë–∞–∑–æ–≤—ã–π |
| Async –ø–æ–¥–¥–µ—Ä–∂–∫–∞ | ‚úÖ | –ï—Å—Ç—å (to_thread) |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å | ‚ö†Ô∏è | –°–ª–∞–±–∞—è |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | ‚ö†Ô∏è | –ù–∏–∑–∫–∞—è (–¥–∏—Å–∫) |
| –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –∫—ç—à | ‚ùå | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |

#### ‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **–¢–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤–æ–π –∫—ç—à**
   ```python
   # –¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥:
   # –ö–∞–∂–¥–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ = –∑–∞–ø–∏—Å—å –Ω–∞ –¥–∏—Å–∫ (~10-50ms)
   # –ö–∞–∂–¥–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ = —á—Ç–µ–Ω–∏–µ —Å –¥–∏—Å–∫–∞ (~5-20ms)
   ```
   - –î–ª—è 1000 —Ä–µ–∫–≤–µ—Å—Ç–æ–≤/—Å–µ–∫ ‚Üí 5-50 —Å–µ–∫ –ø–æ—Ç–µ—Ä–∏ –Ω–∞ I/O

2. **–ù–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**
   ```python
   # –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å:
   # - –°–∫–æ–ª—å–∫–æ –±—ã–ª–æ –ø–æ–ø–∞–¥–∞–Ω–∏–π vs –ø—Ä–æ–º–∞—Ö–æ–≤
   # - –ö–∞–∫–æ–π –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫—ç—à
   # - –†–∞–∑–º–µ—Ä –∫—ç—à–∞
   # - –ù–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
   ```

3. **TTL —Ç–æ–ª—å–∫–æ –ø–æ mtime**
   ```python
   # –ü—Ä–æ–±–ª–µ–º–∞: –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –∏–∑–º–µ–Ω—è–ª—Å—è, –Ω–æ –ø—Ä–æ—Ü–µ—Å—Å –º–µ—Ä—Ç–≤
   # ‚Üí –∑–∞–ø–∏—Å—å –æ—Å—Ç–∞—ë—Ç—Å—è –≤ –∫—ç—à–µ
   # –ù—É–∂–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
   ```

4. **–ë–µ–∑ in-memory —Å–ª–æ—è**
   ```python
   # –î–∞–∂–µ –¥–ª—è –≥–æ—Ä—è—á–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–¥—ë—Ç –¥–∏—Å–∫:
   # L1: Redis (0.1ms)       ‚Üê –û–¢–°–£–¢–°–¢–í–£–ï–¢
   # L2: –ü—Ä–æ—Ü–µ—Å—Å –ø–∞–º—è—Ç—å      ‚Üê –û–¢–°–£–¢–°–¢–í–£–ï–¢
   # L3: –î–∏—Å–∫ (10-50ms)      ‚Üê –¢–û–õ–¨–ö–û –≠–¢–û–¢ –£–†–û–í–ï–ù–¨
   ```

5. **–ù–µ—Ç –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è**
   ```python
   # –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
   # - –ö—ç—à —Ä–∞—Å—Ç—ë—Ç –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ
   # - –°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å—å —É–¥–∞–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ TTL
   # - –ï—Å–ª–∏ TTL=24—á, –¥–∏—Å–∫ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–∏—Ç—å—Å—è
   ```

#### üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

```
–¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞           | –í—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞ | –í—Ä–µ–º—è –∏–∑ –∫—ç—à–∞ | –£–ª—É—á—à–µ–Ω–∏–µ
----------------------|-------------------|---------------|----------
–ê–Ω–∞–ª–∏–∑ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è    | 30-60 —Å–µ–∫         | ~2-5 —Å–µ–∫      | 10-30x
–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è          | 20-40 —Å–µ–∫         | ~0.5-1 —Å–µ–∫    | 20-80x
–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–∞—Ä–∞–∑–∏—Ç | 5-10 —Å–µ–∫          | ~50-100ms     | 50-200x
```

**–í—ã–≤–æ–¥**: –ö—ç—à —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—Ç–æ—Ä–∏—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ ~2-5 —Å–µ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏.

---

## 3. –ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –†–ê–ë–û–¢–ê ‚ö°

### –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### –§–∞–π–ª: `app/services/gigachat.py`

```python
# ‚úÖ –ß–¢–û –ï–°–¢–¨:
- AsyncIO —Å httpx.AsyncClient
- Async –º–µ—Ç–æ–¥—ã (async def + await)
- Retry —Å exponential backoff
- Timeout –Ω–∞ 30 —Å–µ–∫
- Connection pooling –≤ httpx
- async.to_thread –¥–ª—è –±–ª–æ–∫–∏—Ä—É—é—â–µ–≥–æ IO

# ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢:
- –ü—É–ª—ã –∑–∞–¥–∞—á (TaskGroup)
- –õ–∏–º–∏—Ç—ã –Ω–∞ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º
- Graceful shutdown
- Circuit breaker –ø–∞—Ç—Ç–µ—Ä–Ω
```

### –û—Ü–µ–Ω–∫–∞: ‚≠ê‚≠ê‚≠ê‚≠ê (4/5)

#### ‚úÖ –•–æ—Ä–æ—à–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–∞—Å—à—Ç–∞–±–∞

| –§—É–Ω–∫—Ü–∏—è | –ï—Å—Ç—å | –£—Ä–æ–≤–µ–Ω—å |
|---------|------|---------|
| AsyncIO | ‚úÖ | –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã | ‚úÖ | –ï—Å—Ç—å (httpx.AsyncClient) |
| Retry –ª–æ–≥–∏–∫–∞ | ‚úÖ | Exponential backoff |
| Timeout | ‚úÖ | 30 —Å–µ–∫ |
| Graceful shutdown | ‚ö†Ô∏è | –ë–∞–∑–æ–≤—ã–π (lifespan.py) |
| –ü—É–ª—ã –∑–∞–¥–∞—á | ‚ùå | –ù–µ—Ç —è–≤–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
| Rate limiting | ‚ö†Ô∏è | –¢–æ–ª—å–∫–æ retry –Ω–∞ 429 |

#### üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

##### 1. GigaChat API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚úÖ

```python
# app/services/gigachat.py:611-650

# –•–æ—Ä–æ—à–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
max_retries = 3
backoff = 1
for attempt in range(max_retries):
    try:
        response = await self.client.post(...)
        if response.status_code == 200:
            break
        elif response.status_code in (429, 503):
            await asyncio.sleep(backoff)
            backoff *= 2
```

**–û—Ü–µ–Ω–∫–∞**: ‚≠ê‚≠ê‚≠ê‚≠ê (4/5)
- ‚úÖ Exponential backoff —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç rate-limit (429)
- ‚ö†Ô∏è –ù–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ = 1+2+4 = 7 —Å–µ–∫
- ‚ö†Ô∏è –ï—Å–ª–∏ GigaChat –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω, –Ω—É–∂–Ω—ã –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ backoff

##### 2. File IO async ‚ö†Ô∏è

```python
# app/services/cache.py:138

# –¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ - –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô:
await asyncio.to_thread(self.cache.get_by_key, key)
```

**–ü—Ä–æ–±–ª–µ–º–∞**: 
- ‚úÖ –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop
- ‚ö†Ô∏è –ù–æ –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —ç—Ç–æ –º–µ–¥–ª–µ–Ω–Ω–æ
- ‚ö†Ô∏è –ü–æ—Ç–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—ç—à–∞ = –ø–æ—Ç–µ—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥** –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:
```python
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ø–∞–º—è—Ç–∏ –∏–ª–∏ Redis:
cached = self.memory_cache.get(key)  # 0.001ms
if cached: return cached
cached = await self.redis_cache.get(key)  # 1-5ms
```

##### 3. Shutdown handling ‚≠ê‚≠ê‚≠ê

```python
# app/core/lifespan.py

@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup
    yield
    # Shutdown
    await gigachat_client.close()
```

**–û—Ü–µ–Ω–∫–∞**: ‚≠ê‚≠ê‚≠ê (3/5)
- ‚úÖ –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ GigaChat
- ‚ö†Ô∏è –ù–µ—Ç –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ pending –∑–∞–¥–∞—á
- ‚ö†Ô∏è –ù–µ—Ç graceful timeout –ø–µ—Ä–µ–¥ shutdown
- ‚ö†Ô∏è –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ shutdown

---

## 4. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ

### ü•á –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (–ö–†–ò–¢–ò–ß–ù–û)

#### –ü—Ä–æ–±–ª–µ–º–∞
- –ö–∞–∂–¥—ã–π request –∏–∑ –∫—ç—à–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å –¥–∏—Å–∫–∞ (~10-50ms)
- –ù–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è —Ä–∞–∑–º–µ—Ä–∞ –∫—ç—à–∞
- –ù–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

#### –†–µ—à–µ–Ω–∏–µ
```python
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ë—ã—Å—Ç—Ä–æ (—Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º)
# ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π in-memory LRU cache

from functools import lru_cache
from cachetools import TTLCache

class CacheManager:
    def __init__(self):
        # L1: In-memory LRU (–≥–æ—Ä—è—á–∏–µ –¥–∞–Ω–Ω—ã–µ)
        self.memory = TTLCache(maxsize=100, ttl=3600)
        # L2: –î–∏—Å–∫ (—Ö–æ–ª–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)  
        self.disk = AnalysisCache(...)
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏**:
1. **redis** (~50KB, –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ)
   ```bash
   pip install redis
   ```
   - –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ë—ã—Å—Ç—Ä–æ: 1-5ms vs 10-50ms –¥–∏—Å–∫
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –∫—ç—à
   - –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ TTL

2. **cachetools** (~5KB, —á–∏—Å—Ç—ã–π Python)
   ```bash
   pip install cachetools
   ```
   - –î–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ in-memory –∫—ç—à–∞
   - –ù–µ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
   - TTLCache —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —á–∏—Å—Ç–∫–æ–π

3. **diskcache** (~50KB, –¥–ª—è –¥–∏—Å–∫–∞)
   ```bash
   pip install diskcache
   ```
   - –ï—Å–ª–∏ –¥–∏—Å–∫ –Ω—É–∂–µ–Ω, –Ω–æ —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–æ–º
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏–µ LRU
   - –ë—ã—Å—Ç—Ä–µ–µ —á–µ–º pickle –Ω–∞ –¥–∏—Å–∫–µ

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (1-2 —á–∞—Å–∞)

```python
# app/services/cache_manager.py - –ù–û–í–´–ô –§–ê–ô–õ

from cachetools import TTLCache
import redis
import logging

logger = logging.getLogger(__name__)

class CacheManager:
    """–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à: –ø–∞–º—è—Ç—å + Redis/–¥–∏—Å–∫"""
    
    def __init__(self, redis_url: str = None, max_memory_size: int = 100):
        # L1: In-memory –∫—ç—à (–≥–æ—Ä—è—á–∏–µ –¥–∞–Ω–Ω—ã–µ)
        self.memory = TTLCache(maxsize=max_memory_size, ttl=3600)
        
        # L2: Redis –∏–ª–∏ –¥–∏—Å–∫
        if redis_url:
            self.redis = redis.Redis.from_url(redis_url, decode_responses=True)
        else:
            self.redis = None
            
        self.disk = AnalysisCache(Path("cache/analysis"))
    
    async def get(self, key: str) -> Any:
        # L1 –ø–æ–ø—ã—Ç–∫–∞ (0.1ms)
        if key in self.memory:
            logger.debug(f"Cache L1 hit: {key}")
            return self.memory[key]
        
        # L2 –ø–æ–ø—ã—Ç–∫–∞ (1-5ms)
        if self.redis:
            value = await asyncio.to_thread(self.redis.get, key)
            if value: 
                self.memory[key] = value
                return value
        
        # L3 –ø–æ–ø—ã—Ç–∫–∞ (10-50ms)
        value = self.disk.get_by_key(key)
        if value and self.redis:
            await asyncio.to_thread(self.redis.set, key, value, ex=3600)
        return value
    
    async def set(self, key: str, value: Any) -> None:
        self.memory[key] = value
        if self.redis:
            await asyncio.to_thread(self.redis.set, key, value, ex=3600)
        await asyncio.to_thread(self.disk.set_by_key, key, value)
    
    def stats(self) -> dict:
        return {
            "memory_size": len(self.memory),
            "redis_available": self.redis is not None,
            "memory_maxsize": self.memory.maxsize,
        }
```

---

### ü•à –ü–†–ò–û–†–ò–¢–ï–¢ 2: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–í–ê–ñ–ù–û –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)

#### –ü—Ä–æ–±–ª–µ–º–∞
- –ù–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤ (JSON)
- –ù–µ—Ç —Ç—Ä–µ–π—Å–∏—Ä–æ–≤–∞–Ω–∏—è (Request ID)
- –°–ª–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å ELK/Splunk/DataDog

#### –†–µ—à–µ–Ω–∏–µ
```bash
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å JSON –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
pip install pythonjsonlogger

# –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å —Ç—Ä–µ–π—Å–∏–Ω–≥–æ–º
pip install opentelemetry-api opentelemetry-sdk
```

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (1-2 —á–∞—Å–∞)

```python
# app/core/logging_config.py - –û–ë–ù–û–í–ò–¢–¨

from pythonjsonlogger import jsonlogger
import uuid
from contextvars import ContextVar

# –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è Request ID
request_id: ContextVar[str] = ContextVar('request_id', default='')

def setup_logging(...):
    # JSON —Ñ–æ—Ä–º–∞—Ç–µ—Ä –¥–ª—è —Ñ–∞–π–ª–∞
    json_formatter = jsonlogger.JsonFormatter()
    
    file_handler = RotatingFileHandler(...)
    file_handler.setFormatter(json_formatter)
    
    # –¢–µ–∫—Å—Ç —Ñ–æ—Ä–º–∞—Ç–µ—Ä –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ (–∫–∞–∫ —Å–µ–π—á–∞—Å)
    console_handler.setFormatter(console_formatter)

# Middleware –¥–ª—è —Ç—Ä–µ–π—Å–∏—Ä–æ–≤–∞–Ω–∏—è
@app.middleware("http")
async def add_request_id(request: Request, call_next):
    request_id.set(str(uuid.uuid4()))
    response = await call_next(request)
    response.headers["X-Request-ID"] = request_id.get()
    return response

# –í –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç:
# {"timestamp": "2025-12-19T...", "level": "INFO", "request_id": "abc123", "message": "..."}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- ‚úÖ –õ–µ–≥–∫–æ –ø–∞—Ä—Å–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚úÖ Request ID –¥–ª—è —Ç—Ä–µ–π—Å–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ELK/DataDog

---

### ü•â –ü–†–ò–û–†–ò–¢–ï–¢ 3: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å (–•–û–†–û–®–û)

#### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ‚≠ê‚≠ê‚≠ê‚≠ê

–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —É–∂–µ —Ö–æ—Ä–æ—à–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞. –ù—É–∂–Ω—ã –Ω–µ–±–æ–ª—å—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:

#### –ü—Ä–æ–±–ª–µ–º—ã
1. –ù–µ—Ç —è–≤–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–æ–º
2. –ù–µ—Ç circuit breaker –¥–ª—è GigaChat
3. –ù–µ—Ç –º–µ—Ç—Ä–∏–∫ –Ω–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π

#### –†–µ—à–µ–Ω–∏–µ

```python
# –í–∞—Ä–∏–∞–Ω—Ç 1: –î–æ–±–∞–≤–∏—Ç—å circuit breaker
pip install pybreaker

from pybreaker import CircuitBreaker

class GigaChatClient:
    def __init__(self):
        self.breaker = CircuitBreaker(
            fail_max=5,  # –û—Ç–∫–ª—é—á–∏—Ç—å –ø–æ—Å–ª–µ 5 –æ—à–∏–±–æ–∫
            reset_timeout=60  # –ù–∞ 60 —Å–µ–∫
        )
    
    async def analyze_speech(self, ...):
        @self.breaker
        async def _call():
            return await self.client.post(...)
        return await _call()

# –í–∞—Ä–∏–∞–Ω—Ç 2: –î–æ–±–∞–≤–∏—Ç—å —Å–µ–º–∞—Ñ–æ—Ä –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞
class SpeechAnalyzer:
    def __init__(self):
        self.semaphore = asyncio.Semaphore(3)  # –ú–∞–∫—Å 3 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
    
    async def analyze(self, file):
        async with self.semaphore:
            return await self._do_analyze(file)
```

---

## 5. –ò–¢–û–ì–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê –ì–û–¢–û–í–ù–û–°–¢–ò

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°–æ—Å—Ç–æ—è–Ω–∏–µ | –û—Ü–µ–Ω–∫–∞ | –î–ª—è MVP | –î–ª—è Prod | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|-----------|-----------|--------|--------|----------|--------------|
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | ‚úÖ –•–æ—Ä–æ—à–æ | 4/5 | ‚úÖ OK | ‚ö†Ô∏è –ù—É–∂–Ω–æ | JSON + tracing |
| **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** | ‚ö†Ô∏è –ë–∞–∑–æ–≤–æ–µ | 3/5 | ‚úÖ OK | ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ | Redis + memory L1 |
| **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** | ‚úÖ –•–æ—Ä–æ—à–æ | 4/5 | ‚úÖ OK | ‚úÖ –•–æ—Ä–æ—à–æ | Circuit breaker |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | ‚ö†Ô∏è –ú–µ–¥–ª–µ–Ω–Ω–æ | 3/5 | ‚ö†Ô∏è OK | ‚ùå –ù–∏–∑–∫–æ | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫—ç—à–∞ |

---

## 6. –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô –ü–û –ü–†–ò–û–†–ò–¢–ï–¢–ê–ú

### –§–∞–∑–∞ 1: MVP ‚Üí Production (1-2 –Ω–µ–¥–µ–ª–∏)

```
–ù–µ–¥–µ–ª—è 1:
  ‚úÖ –î–µ–Ω—å 1: –î–æ–±–∞–≤–∏—Ç—å Redis –∫—ç—à (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ) –∏–ª–∏ —É–ª—É—á—à–∏—Ç—å –¥–∏—Å–∫ –∫—ç—à
  ‚úÖ –î–µ–Ω—å 2: JSON –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ + Request ID
  ‚úÖ –î–µ–Ω—å 3: Circuit breaker –¥–ª—è GigaChat
  ‚úÖ –î–µ–Ω—å 4-5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π

–ù–µ–¥–µ–ª—è 2:
  ‚úÖ –î–µ–Ω—å 6: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ (–∫—ç—à —Ö–∏—Ç—ã/–ø—Ä–æ–º–∞—Ö–∏)
  ‚úÖ –î–µ–Ω—å 7-10: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
```

### –§–∞–∑–∞ 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–º–µ—Å—è—á–Ω—ã–π —Ü–∏–∫–ª)

```
–ú–µ—Å—è—Ü 1:
  - –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
  - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å TTL –∫—ç—à–∞
  - –î–æ–±–∞–≤–∏—Ç—å OpenTelemetry –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞
```

---

## 7. –í–´–í–û–î–´

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –í–µ—Ä–¥–∏–∫—Ç |
|-----------|---------|
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | 4/5 - **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è MVP, –Ω—É–∂–Ω–æ —É–ª—É—á—à–∞—Ç—å –¥–ª—è Prod** |
| **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** | 3/5 - **–ö–†–ò–¢–ò–ß–ù–û –Ω—É–∂–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** |
| **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** | 4/5 - **–•–æ—Ä–æ—à–æ, –Ω—É–∂–Ω—ã –Ω–µ–±–æ–ª—å—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è** |
| **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ Prod** | ‚ö†Ô∏è **–£—Å–ª–æ–≤–Ω–æ - –Ω—É–∂–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫—ç—à–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è** |

---

## 8. –ú–ï–¢–†–ò–ö–ò –î–û –ò –ü–û–°–õ–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

```
–ú–ï–¢–†–ò–ö–ê                    | –¢–ï–ö–£–©–ï–ï | –ü–û–°–õ–ï OPT | –£–õ–£–ß–®–ï–ù–ò–ï
---------------------------|---------|-----------|----------
–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (–∫—ç—à —Ö–∏—Ç)     | 2-5 —Å–µ–∫ | 0.1-0.5—Å  | 10-50x
–†–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤ –≤ –¥–µ–Ω—å        | 50-100M | 10-20M    | 5-10x
CPU –ø—Ä–∏ 100 RPS            | 85%     | 30-40%    | 2-3x
Memory –ø—Ä–∏ 100 RPS         | 500MB   | 200-300MB | 2-3x
–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å     | 10 RPS  | 100+ RPS  | 10x
```

---

## üìù –î–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ**:
   - –î–æ–±–∞–≤–∏—Ç—å Redis (if available) –∏–ª–∏ —É–ª—É—á—à–∏—Ç—å –¥–∏—Å–∫ –∫—ç—à
   - JSON –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - Request ID middleware

2. **–ù–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é**:
   - Circuit breaker –¥–ª—è GigaChat
   - –ú–µ—Ç—Ä–∏–∫–∏ –∫—ç—à–∞ (hits/misses)
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π

3. **–ù–∞ –º–µ—Å—è—Ü**:
   - OpenTelemetry –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç—Ä–µ–π—Å–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ê–Ω–∞–ª–∏–∑ –±—É—Ç–ª–Ω–µ–∫–æ–≤
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è TTL –∫—ç—à–∞

