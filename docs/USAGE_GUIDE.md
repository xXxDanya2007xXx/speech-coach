# Краткая справка: Новая структура анализа GigaChat

## Что изменилось для пользователей

Анализ выступлений теперь структурирован по разделам для лучшей читаемости:

### Основные разделы анализа

```json
{
    "выступление_анализ": {
        "общее_впечатление": "Краткая оценка выступления",
        "главная_идея": "Основной месседж выступления",
        "оценка_из_100": 85
    },
    
    "структура_и_организация": {
        "оценка": 8,
        "введение": "Как начинается выступление?",
        "основная_часть": "Логика развития идей",
        "заключение": "Сильное ли завершение?"
    },
    
    "содержание": {
        "основные_идеи": ["идея 1", "идея 2", "идея 3"],
        "примеры_и_доказательства": "Есть ли примеры?",
        "оценка": 8
    },
    
    "язык_и_доступность": {
        "уровень_сложности": "простой/средний/сложный",
        "оценка": 8
    },
    
    "доставка_и_беглость": {
        "интерпретация_темпа": "Что означает скорость речи",
        "интерпретация_паразитов": "Что означает частота \"э\", \"так\"",
        "интерпретация_пауз": "Что означают паузы",
        "оценка": 8
    },
    
    "сильные_стороны": [
        "Сильная сторона 1 с примером",
        "Сильная сторона 2 с примером"
    ],
    
    "области_для_улучшения": [
        {
            "проблема": "ЧТО нужно улучшить",
            "причина": "ПОЧЕМУ это проблема",
            "решение": "КАК это исправить"
        }
    ],
    
    "главные_рекомендации": [
        "Действенная рекомендация 1 (которую можно выполнить за неделю)",
        "Действенная рекомендация 2"
    ],
    
    "приоритет_развития": "Какой ОДИН навык улучшить в первую очередь?",
    "уровень_уверенности": 0.85
}
```

---

## Новые возможности

### 1. **Интерпретация метрик**

Теперь каждая метрика не просто число, а имеет объяснение:

```
Темп речи: 135 слов/минуту
(Интерпретация: быстро - может быть энергией или спешкой)

Паразиты: 1.5 на 100 слов
(Норма: < 2 на 100 слов | Текущий уровень: ХОРОШО)
```

### 2. **Структурированные рекомендации**

Вместо просто "улучши громкость", теперь:
```
Проблема: Часто повторяешь "так, и"
Причина: Это снижает уверенность слушателей
Решение: Заменить "так, и" на паузы (практикуй 10 мин в день)
```

### 3. **Приоритизация развития**

Вместо множества рекомендаций - один главный приоритет:
```
"Приоритет_развития": "Снизить частоту паразитов - это главное, что повысит уверенность"
```

### 4. **Оценки по разделам**

Теперь видно сильные и слабые стороны по конкретным критериям:
- Структура: 8/10
- Содержание: 7/10
- Язык: 9/10
- Доставка: 6/10

---

## Обратная совместимость

✅ Система поддерживает **оба формата** JSON:

**Если вернулся новый формат (вариант 3):**
- Данные автоматически преобразуются в совместимый формат
- Все поля становятся доступны как раньше

**Если вернулся старый формат:**
- Работает как раньше без изменений

---

## Примеры использования результатов

### Python код

```python
# Результат анализа в виде dict
analysis = {
    "выступление_анализ": {...},
    "структура_и_организация": {...},
    ...
}

# Обращение к конкретным полям
оценка_структуры = analysis["структура_и_организация"]["оценка"]
главная_идея = analysis["выступление_анализ"]["главная_идея"]
рекомендации = analysis["главные_рекомендации"]
```

### API ответ

```json
{
    "analysis": {
        "выступление_анализ": {...},
        "структура_и_организация": {...},
        ...
    },
    "metrics": {...},
    "transcript": "..."
}
```

---

## Часто задаваемые вопросы

### Q: Что если анализ вернулся в старом формате?
A: Ничего не сломается! Система автоматически преобразует его в новый формат.

### Q: Зачем столько оценок (1-10 по каждому разделу)?
A: Чтобы видеть сильные и слабые стороны по конкретным критериям, а не общую оценку.

### Q: Почему только одна главная рекомендация в приоритете?
A: Изучения показывают, что студент с большей вероятностью выполнит одну главную рекомендацию, чем списать 5 пунктов.

### Q: Что означает "уровень_уверенности"?
A: Это оценка, насколько модель уверена в своем анализе (0 = неуверена, 1 = очень уверена).

---

## Миграция кода (если нужна)

### Старый код
```python
def process_analysis(result):
    print(result.overall_assessment)
    for strength in result.strengths:
        print(strength)
```

### Новый код
```python
def process_analysis(result):
    # Работает со старым И новым форматом
    print(result.overall_assessment)
    for strength in result.strengths:
        print(strength)
    
    # Если нужны новые поля, обращайся напрямую к dict
    if hasattr(result, '__dict__'):
        new_format = result.__dict__
        структура = new_format.get("структура_и_организация", {})
        print(структура.get("оценка"))
```

---

## Важные изменения в логике

### Интерпретация метрик

**Раньше:** "Темп: 135 слов/мин"

**Теперь:**
```
Темп: 135 слов/мин
Интерпретация: быстро (140-160)
Это говорит о: спешке или энергии говорящего
```

### Полный транскрипт

**Раньше:** Сокращалось до 3000 символов

**Теперь:** Передается полностью для точного анализа

### Валидация

**Раньше:** Если JSON невалидный → fallback с низким качеством

**Теперь:**
1. Пробуем распарсить
2. Применяем 4 стратегии очистки
3. Валидируем оба формата
4. Graceful fallback только как крайняя мера

---

## Логирование и отладка

При ошибке парсинга JSON:
```
[WARNING] Failed to parse GigaChat response after retries
[DEBUG] Original content: {...}
[DEBUG] Cleaned content: {...}
```

При успешной валидации:
```
[INFO] Analysis validated successfully with new format
[INFO] Converted to compatible format for GigaChatAnalysis
```

---

## Контакты и поддержка

Если что-то не работает как ожидается:
1. Проверь логи в `/workspaces/speech-coach/logs/`
2. Смотри документацию в `PROMPT_IMPROVEMENTS.md`
3. Убедись что GigaChat API ключ активен
